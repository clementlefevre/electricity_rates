---
title: "Raster Conagua temp with munid shapefile"
output: html_notebook
---

```{r}
library(dplyr)
library(stringr)
library(stringi)
library(tidyverse)
library(raster)
library(maptools)
library(sp)
library(gstat)
library(rgdal)
```


### Read data
```{r}
df.stations.infos<- read.csv('data/conagua_stations_infos.csv')
df.stations.temp<- read.csv('data/conagua_stations_temp.csv')
```

### Merge Conagua stations infos with Conagua stations temperatures
```{r}
df.stations.infos$ESTACION <- as.character(df.stations.infos$ESTACION)
df.stations.infos$X <- NULL
df.stations.temp$ESTACION <- str_extract(df.stations.temp$ID,"[^/]+(?=V)")

df.stations.temp<- df.stations.temp %>% dplyr::select(one_of(c('ESTACION', 'ID','LATITUD','LONGITUD','YEAR',month.abb[seq(1:12)])))
df.stations.temp <- df.stations.temp %>% filter(!is.na(ID))
df.stations.infos.temp <- merge(df.stations.temp,df.stations.infos, by='ESTACION',all.x=TRUE)
anti_join(df.stations.temp,df.stations.infos,by='ESTACION') %>% group_by(ID) %>% summarise(n())
```
```{r}
df.stations.temp %>% dplyr::filter( (ID=='10001V_7')) %>% arrange(YEAR)
```

### Arrange data per MIN/MAX- Year -  Month :
```{r}

date_range <- c(2010:2016)

df <- df.stations.infos.temp %>% dplyr::filter(YEAR %in% date_range)
df <- df %>% gather(month,temp,month.abb[seq(1:12)])
df <- df %>% mutate(year.month.temp = str_replace_all(str_c(title,YEAR,month, sep = ".", collapse = NULL),'[:blank:]','.'))

# mo2Num <- function(x) match(tolower(x), tolower(month.abb))
# df.stations.infos.temp<- df.stations.infos.temp %>%mutate_at('month', funs(mo2Num))
# 
# df.stations.infos.temp <- df.stations.infos.temp[with(df.stations.infos.temp, order(YEAR,month)), ]
# 
# DATE.TEMP.TYPE <- unique(df.stations.infos.temp$year.month.temp)

```

### Convert the temperatures dataframe into a spatial grid 
```{r}

x.range <- as.numeric(c(-116.908, -86.82))  # min/max longitude of the interpolation area
y.range <- as.numeric(c(14.618, 32.715))  # min/max latitude of the interpolation area

grd <- expand.grid(x = seq(from = x.range[1], to = x.range[2], by = .1), y = seq(from = y.range[1], 
    to = y.range[2], by = .1))  # expand points to grid
coordinates(grd) <- ~x + y
gridded(grd) <- TRUE


rasterize.date.temp <- function(date.temp){
  
spg.df <- df.stations.infos.temp %>% filter ((!is.na(ID))& !is.na(temp)) %>%  filter(year.month.temp==date.temp)%>% dplyr::select(LATITUD,LONGITUD,temp)

colnames(spg.df)<- c('lat','lon','temp')
spg<- spg.df
coordinates(spg) <- ~  lon + lat

## Extrapolate the temperature for the whole grid :
idw <- idw(formula = temp ~ 1, locations = spg,    newdata = grd)  # apply idw model for the data

idw.output = as.data.frame(idw)  # output is defined as a data table
names(idw.output)[1:3] <- c("lon", "lat", "temp.pred")  # give names to the modelled variables


ggplot() + geom_tile(data = idw.output, aes(x = lon, y = lat, fill = ((temp.pred))))+geom_point(data = spg.df, aes(x = lon, y=lat),shape=1,size=.1)+
  labs(title='Conagua Jan 2010 Min Temp Prom')+ scale_fill_distiller(palette = "Spectral")

raster.conagua <-raster(idw)
crs(raster.conagua) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
print(date.temp)
names(raster.conagua)<- date.temp
return (raster.conagua)
}

```


```{r}
for (date.temp in head(DATE.TEMP.TYPE,3)){
  print(date.temp)
  rasta <- rasterize.date.temp(date.temp)
  
  if(which(DATE.TEMP.TYPE==date.temp)==1){
    raster.merge <- rasta
  } 
  else {
    raster.merge <- raster::stack(raster.merge,rasta)
  }
}

#raster.merge <- raster::stack(raster.test1,raster.test2)

```


## old idw
```{r}

spg.df<- df.stations.infos.temp
spg.df <- spg.df %>% filter (!is.na(ID)) %>%  filter(YEAR==2010) %>% filter(title=='TEMP MINIMA PROM') %>%  filter(!is.na(Jan))%>% dplyr::select(LATITUD,LONGITUD,Jan)
colnames(spg.df)<- c('y','x','Jan')
spg<- spg.df
coordinates(spg) <- ~  x + y 
plot(spg)

x.range <- as.numeric(c(-116.908, -86.82))  # min/max longitude of the interpolation area
y.range <- as.numeric(c(14.618, 32.715))  # min/max latitude of the interpolation area

grd <- expand.grid(x = seq(from = x.range[1], to = x.range[2], by = .1), y = seq(from = y.range[1], 
    to = y.range[2], by = .1))  # expand points to grid
coordinates(grd) <- ~x + y
gridded(grd) <- TRUE
plot(grd, cex = 1.5, col = "grey")
points(spg, pch = 1, col = "red", cex = 1)

idw <- idw(formula = Jan ~ 1, locations = spg, 
    newdata = grd)  # apply idw model for the data

idw.output = as.data.frame(idw)  # output is defined as a data table
names(idw.output)[1:3] <- c("long", "lat", "temp.pred")  # give names to the modelled variables


ggplot() + geom_tile(data = idw.output, aes(x = long, y = lat, fill = ((temp.pred))))+geom_point(data = spg.df, aes(x = x, y=y),shape=1,size=.1)+
  labs(title='Conagua Jan 2010 Min Temp Prom')+ scale_fill_distiller(palette = "Spectral")

```


## Raster the extrapolation grid and extract it on the Munid Shapefile :
```{r}
raster.conagua <-raster(idw)
crs(raster.conagua) <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" 
muni.shp<-readOGR(dsn="gis/shapefiles/conjunto_de_datos/",layer = "areas_geoestadisticas_municipales")

rgeo <- projectRaster(raster.conagua, crs='+proj=longlat +datum=WGS84')
pgeo <- spTransform(muni.shp, CRS('+proj=longlat +datum=WGS84'))

# plot on top of Google map
e <- union(extent(rgeo), extent(pgeo))
print(e)

#g <- gmap(e,lonlat=TRUE,style='feature:landscape|element:geometry|saturation:-100&style=feature:water|saturation:-100|invert_lightness:true',scale=2)
#writeRaster(g,'data/mexico_raster.grd' ,datatype='INT4S', overwrite=TRUE)

g2<- raster('data/mexico_raster.grd')
plot(g2, inter=TRUE)
plot(extent(rgeo), add=TRUE, col='red', lwd=2)
plot(pgeo, add=TRUE, col='blue', lwd=.1)

```
```{r}
#extraction <-extract(rgeo,pgeo, weights = TRUE, normalizeWeights=TRUE, fun=mean,df=TRUE)
extraction <-raster::extract(rgeo,pgeo,fun=mean,df=TRUE)

pgeo@data <- data.frame(pgeo@data, means=extraction)

sp::spplot(pgeo, "means.var1.pred",lwd=.1,title ='Mean temp (Celsius) for August 2014')
```

