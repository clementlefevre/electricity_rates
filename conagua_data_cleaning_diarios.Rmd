---
title: "Convert CONAGUA Diarios Temperatures to Raster File"
output: html_notebook
---

```{r}
library(dplyr)
library(stringr)
library(stringi)
library(tidyverse)


Sys.setlocale("LC_MESSAGES", 'en_GB.UTF-8')
Sys.setlocale('LC_ALL','en_GB.UTF-8')
Sys.setenv(LANG = "en_US.UTF-8")
```


## Create a list of files that are Mensuales 
Yes, when we downloaded the files, we did not check whether the files names were consistent.
Then we filter on file urls that contains the 'Mensuales' keyword to scrap the monthly average value per station.

```{r}
cols_url <- paste("V", 1:7,sep='_')
df.files <- read.csv('data/conagua_files_list.csv',encoding = 'utf-8')
df.files.gather<- df.files %>% dplyr::select(c('ID',cols_url )) %>% gather(key=vector,value=url,-ID)
df.files.diarios <- df.files.gather %>% dplyr::filter(.,grepl('Diarios',url))
str(df.files.diarios)
head(df.files.diarios)
df.files.diarios$filename<- paste(df.files.diarios$ID,df.files.diarios$vector,'.txt',sep='')
```



## Combine all stations info into dataframe

```{r}
all_files <-list.files(DATA_FOLDER <- 'data/sonaguas')
all_infos_files <- all_files[grepl('(V_1)',all_files)]
all_temp_files <- df.files.diarios$filename

```


## Read the full history file and retrieve the station informations 

```{r}
get_stations_diarios <- function(filename){
  
  tryCatch({
  
  DATA_FOLDER <- 'data/sonaguas'
 
  filename <-paste(DATA_FOLDER,filename,sep='/')
  
  con <- file(filename)
  lns <- readLines(filename)
  
  col.names <- c('date','PRECIP','EVAP' ,'TMAX','TMIN')
  
  start.read.diarios <- grep('FECHA',lns)[1]+2
  end.read.diarios <- grep('---------',lns)[-1]
  
  print (start.read.diarios)
  print (end.read.diarios)
  
   if((length(start.read.diarios)>0) & (length(end.read.diarios)>0)){
  print ('coucou')
  df.diarios <- read.fwf(filename, width=c(10,rep(8,each=2),7,7),col.names=col.names,skip=start.read.diarios,n=end.read.diarios-start.read.diarios,encoding = 'UTF-8')
  
 print (df.diarios)
  close(con)
  
  }
  },error=function(cond) {
            message(paste("file could not be wrapped :", filename))
  })
  return(df.diarios)
}

```


```{r}
df.test <- get_stations_diarios('1001V_1.txt')
```
## Read the temperature text file for a given Station and convert the MIN/MAX Tem Prom to Dataframe


