---
title: "Combine Raster temperature with Mexico municipalities Shapefile"
output:
  html_document: html_notebook

---


```{r}
library(readstata13)
library(dplyr)
library(ncdf4)
library(raster)
library(sp)
library(rgeos)
library(rgdal)
library(dismo)
```
## Read ShapeFile and Raster File.
```{r}

muni.shp<-readOGR(dsn="gis/shapefiles/conjunto_de_datos/",layer = "areas_geoestadisticas_municipales")

RASTER_FILE_NAME <- 'gis/noaa_temperatures/air.mon.mean.nc'

DATES <- c(836:838)

r.stack<-stack(RASTER_FILE_NAME,bands=DATES)
r.stack<- rotate(r.stack)

data.frame( rasterToPoints( r.stack ) )

mexico_limits <- extent(-118,-82,14,34)
r.stack <- crop(r.stack, mexico_limits)
print (r.stack)
#df.r<- as.data.frame(rc,xy=TRUE,optional = TRUE)
plot(r.stack)
```

## Project both Shapefile and Raster  on WGS84 and check that they match on the map.
```{r}

# tranform both data set to longlat
#muni.shp<- subset(muni.shp,CVE_ENT=='01')

rgeo <- projectRaster(r.stack, crs='+proj=longlat +datum=WGS84')
pgeo <- spTransform(muni.shp, CRS('+proj=longlat +datum=WGS84'))

# plot on top of Google map
e <- union(extent(rgeo), extent(pgeo))
print(e)
#g <- gmap(e,lonlat=TRUE)
plot(g, inter=TRUE)
plot(extent(rgeo), add=TRUE, col='red', lwd=2)
plot(pgeo, add=TRUE, col='blue', lwd=.1)
```
```{r}
kelvins_to_celsius= function(x){
  return (x-273.15)
}
```

```{r}
#extraction <-extract(rgeo,pgeo, weights = TRUE, normalizeWeights=TRUE, fun=mean,df=TRUE)
extraction <-extract(rgeo,pgeo,fun=mean,df=TRUE)
extraction <- extraction  %>% mutate_at(vars(-ID),funs(kelvins_to_celsius))
pgeo@data <- data.frame(pgeo@data, means=extraction)
spplot(pgeo, "means.X2017.09.01",lwd=.1,title ='Mean temp (Celsius) for August 2014')

```

## Read and add tariffa to shapefile data :
```{r}
pgeo@data <- pgeo@data %>% mutate(id = paste(CVE_ENT,CVE_MUN,sep=''))

df.tariffa<-  read.dta13('gis/tariff/Tariffs.dta')
summary(df.tariffa)
df.temp.tariffa.munid<- left_join(pgeo@data,df.tariffa, by='id')

head(df.temp.tariffa.munid)
```
