---
title: "Combine Raster temperature with Mexico municipalities Shapefile"
output:
  html_notebook: default
  html_document:
    highlight: textmate
    theme: spacelab
    toc: yes
---


```{r}
library(dplyr)
library(ncdf4)
library(raster)
library(sp)
library(rgeos)
library(rgdal)
library(dismo)
```
## Read ShapeFile and Raster File.
```{r}

muni.shp<-readOGR(dsn="gis/shapefiles/conjunto_de_datos/",layer = "areas_geoestadisticas_municipales")

RASTER_FILE_NAME <- 'gis/noaa_temperatures/air.mon.mean.nc'

DATES <- c(800:838)

r.stack<-stack(RASTER_FILE_NAME,bands=DATES)
r.stack<- rotate(r.stack)

data.frame( rasterToPoints( r.stack ) )

mexico_limits <- extent(-118,-82,14,34)
r.stack <- crop(r.stack, mexico_limits)
print (r.stack)
#df.r<- as.data.frame(rc,xy=TRUE,optional = TRUE)
plot(r.stack)
```

## Project both Shapefile and Raster  on WGS84 and check that they match on the map.
```{r}

# tranform both data set to longlat
#myshp<- subset(myshp,CVE_ENT=='01')

rgeo <- projectRaster(r.stack, crs='+proj=longlat +datum=WGS84')
pgeo <- spTransform(muni.shp, CRS('+proj=longlat +datum=WGS84'))

# plot on top of Google map
e <- union(extent(rgeo), extent(pgeo))
print(e)
g <- gmap(e,lonlat=TRUE)
plot(g, inter=TRUE)
plot(extent(rgeo), add=TRUE, col='red', lwd=2)
plot(pgeo, add=TRUE, col='blue', lwd=2)
```
```{r}
kelvins_to_celsius= function(x){
  return (x-273.15)
}
```

```{r}
#extraction <-extract(rgeo,pgeo, weights = TRUE, normalizeWeights=TRUE, fun=mean,df=TRUE)
extraction <-extract(rgeo,pgeo,fun=mean,df=TRUE)

extraction <- extraction  %>% mutate_at(vars(-ID),funs(kelvins_to_celsius))


pgeo@data <- data.frame(pgeo@data, means=extraction)
  str(pgeo@data)
spplot(pgeo, "means.X2014.08.01.01.06.32")
df.mean.temp.per.muni.history<-as.data.frame(pgeo@data)
```

